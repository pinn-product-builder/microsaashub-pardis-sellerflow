name: Deploy Supabase Cloud (DB + Edge Functions)

on:
  push:
    branches: [main]
  workflow_dispatch: {}

concurrency:
  group: supabase-cloud-deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: 2.72.7

      - name: Link project
        run: supabase link --project-ref "$SUPABASE_PROJECT_REF"

      - name: Push migrations (remote)
        run: supabase db push --yes

      - name: Deploy Edge Functions
        run: |
          set -euo pipefail
          functions=(
            "calculate-pricing"
            "process-approval"
            "vtex-create-orderform"
            "vtex-cron-clients"
            "vtex-ping"
            "vtex-sync-clients"
            "vtex-sync-inventory"
            "vtex-sync-prices"
            "vtex-sync-products"
            "vtex-sync-skus"
            "vtex-create-coupon"
          )
          for fn in "${functions[@]}"; do
            echo "Deploying $fn..."
            supabase functions deploy "$fn"
          done

