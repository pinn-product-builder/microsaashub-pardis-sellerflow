contract:
  name: "Hermes Pardini | VTEX Sync SKUs"
  version: "1.1.0"
  last_updated: "2026-01-23"
  owner:
    company: "Pinn / Pardis SellerFlow"
    responsible: "Pedro Henrique Ventura"
  goal: >
    Sincronizar detalhes de SKUs da VTEX para o Supabase (tabela vtex_skus),
    garantindo preenchimento de name e vtex_product_id.
    Atualização de contrato: incluir campos de catálogo solicitados (embalagem/gramatura) e campo de validade do SKU.

environments:
  vtex:
    account: "hermespardini"
    admin_base: "https://hermespardini.myvtex.com/admin"
    api_base: "https://hermespardini.vtexcommercestable.com.br"
    auth:
      type: "AppKey/AppToken"
      headers:
        - name: "X-VTEX-API-AppKey"
          value: "<VTEX_APP_KEY>"
        - name: "X-VTEX-API-AppToken"
          value: "<VTEX_APP_TOKEN>"
  supabase:
    local_base: "http://127.0.0.1:65421/functions/v1"
    cloud_base: "https://<PROJECT_REF>.supabase.co/functions/v1"
    auth:
      execution:
        - "Admin autenticado (JWT em Authorization)"
        - "OU header x-vtex-sync-secret (VTEX_SYNC_SECRET) para automação/cron"
      note: "Não expor sync publicamente com anon key sem proteção."

interface:
  edge_function:
    name: "vtex-sync-skus"
    method: "GET"
    path: "/vtex-sync-skus"
    query_params:
      page:
        type: "integer"
        required: false
        default: 1
        min: 1
      pageSize:
        type: "integer"
        required: false
        default: 200
        min: 1
        max: 500
      missingOnly:
        type: "boolean"
        required: false
        default: true
        description: "Quando true, busca apenas skus ainda não persistidos (ou incompletos, se aplicável)."
      concurrency:
        type: "integer"
        required: false
        default: 4
        min: 1
        max: 10
      salesChannelId:
        type: "integer"
        required: false
        default: 1
        description: "Canal de venda para escopo de SKUs (quando usado na coleta da lista de IDs)."

  response_200:
    content_type: "application/json"
    schema:
      ok: { type: "boolean", example: true }
      page: { type: "integer", example: 1 }
      pageSize: { type: "integer", example: 200 }
      missingOnly: { type: "boolean", example: true }
      concurrency: { type: "integer", example: 4 }
      totalSkusInScope: { type: "integer", example: 4281 }
      batchSize: { type: "integer", example: 200 }
      upserted: { type: "integer", example: 200 }
      errorsCount: { type: "integer", example: 0 }
      errors:
        type: "array"
        items:
          type: "object"
          properties:
            skuId: { type: "integer" }
            error: { type: "string" }
      next:
        type: "object|null"
        properties:
          page: { type: "integer" }
          pageSize: { type: "integer" }

upstream_calls:
  vtex_endpoints_used:
    - name: "List SKU ids by Sales Channel"
      method: "GET"
      url: "https://{account}.{env}/api/catalog_system/pvt/sku/stockkeepingunitidsbysaleschannel/{salesChannelId}"
      notes:
        - "Usado para determinar o universo (totalSkusInScope)."
    - name: "Get SKU by id"
      method: "GET"
      url: "https://{account}.{env}/api/catalog_system/pvt/sku/stockkeepingunitbyid/{skuId}"
      notes:
        - "Fonte principal de name (SkuName/NameComplete/ProductName) e vtex_product_id (ProductId)."

data_persistence:
  supabase_tables:
    - table: "vtex_skus"
      pk: "vtex_sku_id"
      upsert_conflict_key: "vtex_sku_id"
      columns:
        vtex_sku_id: "number (from Id)"
        vtex_product_id: "number|null (from ProductId)"
        name: "string|null (best-effort from SkuName/NameComplete/ProductName)"
        is_active: "boolean|null (from IsActive)"
        ean: "string|null (best-effort; digits-only)"
        ref_id: "string|null (best-effort)"
        embalagem: >
          "string|null (campo solicitado).
          Fonte preferencial: especificação do SKU (ex.: 'Embalagem').
          Fallback: extração heurística do name/name_complete (ex.: 'cx 100', 'kit 10', 'pct 50')."
        gramatura: >
          "string|null (campo solicitado).
          Fonte preferencial: especificação do SKU (ex.: 'Gramatura').
          Fallback: extração heurística do name/name_complete (ex.: '20g', '500ml', '10cm')."
        validade_sku: >
          "string|date|null (campo solicitado).
          Fonte: especificação do SKU (ex.: 'Validade' / 'validade').
          Observação: o formato exato (date vs texto) será validado com o cliente e normalizado na persistência."
        raw: "jsonb (payload completo do SKU)"
      guarantees:
        - "Upsert idempotente por vtex_sku_id."
        - "name não deve ficar null para SKUs válidos retornados pela VTEX (salvo exceções)."

acceptance_criteria:
  functional:
    - "Após rodar até o final, query de validação (name is null) deve retornar 0 (ou justificar exceções)."
    - "totalSkusInScope deve bater com a VTEX para o salesChannelId validado."
    - "Campos embalagem/gramatura/validade_sku devem estar preenchidos para SKUs onde a VTEX possui especificação correspondente."
  observability:
    - "Resposta sempre inclui next (ou null) e métricas por página."
  security:
    - "Execução restrita (admin JWT ou x-vtex-sync-secret)."
    - "Não logar PII/segredos; logar apenas métricas e IDs."